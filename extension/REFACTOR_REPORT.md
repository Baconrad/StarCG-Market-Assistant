# StarCG Market Extension - ä»£ç¢¼é‡æ§‹å ±å‘Š

## æ¦‚è¿°
æœ¬å ±å‘Šè©³ç´°èªªæ˜äº†å° StarCG Market Extensionï¼ˆWXT + Vue 3 Chrome æ“´å……åŠŸèƒ½ï¼‰é€²è¡Œçš„ç³»çµ±æ€§ä»£ç¢¼é‡æ§‹ã€‚é‡æ§‹çš„ç›®æ¨™æ˜¯æå‡ä»£ç¢¼å“è³ªã€å¯ç¶­è­·æ€§ã€å¯æ“´å±•æ€§å’Œé¡å‹å®‰å…¨æ€§ã€‚

---

## é‡æ§‹å‰å­˜åœ¨çš„å•é¡Œ

### 1. é¡å‹å®‰å…¨ä¸è¶³
- **å•é¡Œ**ï¼šæ¶ˆæ¯ç³»çµ±ä½¿ç”¨ `any` é¡å‹æˆ–å­—ç¬¦ä¸²å­—é¢é‡ï¼Œæ²’æœ‰ç·¨è­¯æ™‚é¡å‹æª¢æŸ¥
- **å½±éŸ¿**ï¼šå®¹æ˜“ç”¢ç”Ÿé‹è¡Œæ™‚éŒ¯èª¤ï¼ŒIDE ç„¡æ³•æä¾›æº–ç¢ºçš„ä»£ç¢¼è£œå…¨
- **ç¤ºä¾‹**ï¼š`msg.type === 'fetchMarket'` ä½¿ç”¨å­—ç¬¦ä¸²æ¯”è¼ƒ

### 2. ä»£ç¢¼é‡è¤‡
- **å•é¡Œ**ï¼šå¤šå€‹æ–‡ä»¶ä¸­é‡è¤‡æª¢æŸ¥ `browser.runtime` å’Œ `chrome.runtime`
- **å½±éŸ¿**ï¼šä»£ç¢¼å†—é•·ï¼Œç¶­è­·æˆæœ¬é«˜ï¼Œæ˜“å‡ºç¾ä¸ä¸€è‡´çš„å¯¦ç¾
- **é‡è¤‡é»**ï¼š
  - popup å’Œ market çµ„ä»¶éƒ½æœ‰é‡è¤‡çš„ storage è¨ªå•é‚è¼¯
  - æ¶ˆæ¯ç™¼é€é‚è¼¯åœ¨å¤šå€‹çµ„ä»¶ä¸­é‡è¤‡å¯¦ç¾

### 3. é—œæ³¨é»æ··äº‚
- **å•é¡Œ**ï¼šbackground.ts æ··åˆäº† API èª¿ç”¨ã€æ•¸æ“šè™•ç†ã€æ¶ˆæ¯è·¯ç”±å’Œå­˜å„²ç®¡ç†
- **å½±éŸ¿**ï¼šå–®å€‹æ–‡ä»¶è¶…é 100 è¡Œä¸”è·è²¬ä¸æ¸…ï¼Œä¸ç¬¦åˆå–®ä¸€è·è²¬åŸå‰‡
- **å…·é«”**ï¼šAPI èª¿ç”¨é‚è¼¯ã€åˆ†é é‚è¼¯ã€éæ¿¾é‚è¼¯éƒ½æ··åœ¨ä¸€èµ·

### 4. ç¼ºä¹æŠ½è±¡å±¤
- **å•é¡Œ**ï¼šæ²’æœ‰å°ˆç”¨çš„ service å±¤ä¾†å°è£æ¥­å‹™é‚è¼¯
- **å½±éŸ¿**ï¼šçµ„ä»¶é‚è¼¯éé‡ï¼Œé›£ä»¥æ¸¬è©¦å’Œè¤‡ç”¨

### 5. å¸¸é‡å’Œé…ç½®æ•£äº‚
- **å•é¡Œ**ï¼šmagic numberï¼ˆå¦‚ 175ï¼‰å’Œ API URLs ç¡¬ç·¨ç¢¼åœ¨ä»£ç¢¼ä¸­
- **å½±éŸ¿**ï¼šä¿®æ”¹é…ç½®éœ€è¦æ”¹å‹•å¤šå€‹æ–‡ä»¶

### 6. éŒ¯èª¤è™•ç†ä¸ä¸€è‡´
- **å•é¡Œ**ï¼šå˜—è©¦-æ•ç²å’Œ alert/console.error æ··äº‚ä½¿ç”¨
- **å½±éŸ¿**ï¼šç”¨æˆ¶é«”é©—å·®ï¼Œèª¿è©¦å›°é›£

---

## é‡æ§‹æ–¹æ¡ˆ

### 1. å»ºç«‹å®Œæ•´çš„é¡å‹ç³»çµ±ï¼ˆ`types/` ç›®éŒ„ï¼‰

#### `types/messages.ts`
```typescript
// çµ±ä¸€æ¶ˆæ¯é¡å‹å®šç¾©
- FetchMarketMessage / FetchMarketResponse
- AddTrackedMessage / AddTrackedResponse
- AnyMessage (è¯åˆé¡å‹)
- MessageResponse (è¯åˆé¡å‹)
```
**å„ªé»**ï¼š
- ç·¨è­¯æ™‚é¡å‹æª¢æŸ¥
- IDE ä»£ç¢¼è£œå…¨
- æ˜“æ–¼æ“´å±•æ–°æ¶ˆæ¯é¡å‹

#### `types/storage.ts`
```typescript
// å­˜å„²æ•¸æ“šé¡å‹å®šç¾©
- StorageData (å…¨é«”å­˜å„²çµæ§‹)
- StorageKey (å­˜å„²é‘°åŒ™é¡å‹)
```

#### `types/market.ts`
```typescript
// å¸‚å ´ç›¸é—œé¡å‹
- Payment (è¡¨æ ¼æ•¸æ“šçµæ§‹)
- ItemType, PriceType (æšèˆ‰é¡å‹)
- ItemFilterOptions (éæ¿¾é¸é …)
```

### 2. å»ºç«‹å·¥å…·å±¤ï¼ˆ`utils/` ç›®éŒ„ï¼‰

#### `utils/messaging.ts` - çµ±ä¸€æ¶ˆæ¯ç³»çµ±
```typescript
sendMessage<T>()     // éš±è— browser/chrome API å·®ç•°
onMessage()          // çµ±ä¸€æ¶ˆæ¯ç›£è½
getExtensionUrl()    // ç²å–æ“´å…… URL
```
**æ”¹é€²**ï¼š
- âœ… ä¸€æ¬¡å¯¦ç¾ï¼Œåˆ°è™•ä½¿ç”¨
- âœ… è‡ªå‹•è™•ç† browser/chrome å·®ç•°
- âœ… Promise-based API (ç¾ä»£åŒ–)
- âœ… é¡å‹å®‰å…¨ï¼Œæ”¯æŒæ³›å‹

#### `utils/storage.ts` - çµ±ä¸€å­˜å„²è¨ªå•
```typescript
getStorage<K>()      // é¡å‹å®‰å…¨çš„ç²å–
setStorage<K>()      // é¡å‹å®‰å…¨çš„è¨­ç½®
removeStorage()      // ç§»é™¤å–®å€‹é‘°åŒ™
clearStorage()       // æ¸…ç©ºæ‰€æœ‰
```
**æ”¹é€²**ï¼š
- âœ… ä¸€å±¤æŠ½è±¡ï¼Œæ”¯æŒ browser.storageã€chrome.storageã€localStorage
- âœ… è‡ªå‹•å¾Œé€€ç­–ç•¥
- âœ… éŒ¯èª¤è™•ç†

#### `utils/api.ts` - API æœå‹™å±¤
```typescript
fetchMarketData()              // å–®é ç²å–
fetchAllMarketPages()          // éè¿´åˆ†é 
filterMarketDataBySearch()     // æœå°‹ç¯©é¸
getTimeUntilExpiration()       // æ™‚é–“è¨ˆç®—
extractCdKey(), etc.           // æ•¸æ“šæå–å·¥å…·
```
**æ”¹é€²**ï¼š
- âœ… éš”é›¢å¤–éƒ¨ API é‚è¼¯
- âœ… å¯è¤‡ç”¨çš„å·¥å…·å‡½æ•¸
- âœ… æ¨™æº–åŒ–æ•¸æ“šè½‰æ›

#### `utils/constants.ts` - é…ç½®ç®¡ç†
```typescript
API_CONFIG        // API ç›¸é—œé…ç½®
MARKET_CONFIG     // å¸‚å ´ç›¸é—œé…ç½®
ERROR_MESSAGES    // çµ±ä¸€éŒ¯èª¤æ¶ˆæ¯
SUCCESS_MESSAGES  // çµ±ä¸€æˆåŠŸæ¶ˆæ¯
```
**æ”¹é€²**ï¼š
- âœ… å–®ä¸€é…ç½®æº
- âœ… æ˜“æ–¼åœ‹éš›åŒ– (i18n)
- âœ… é›†ä¸­ç®¡ç†

### 3. é‡æ§‹ Background Service Worker

**å¾**ï¼š100+ è¡Œæ··äº‚çš„é‚è¼¯
**åˆ°**ï¼šæ¸…æ™°çš„æ¶ˆæ¯è·¯ç”±å’Œæœå‹™èª¿ç”¨

```typescript
// æ–°çµæ§‹
export default defineBackground(() => {
  onMessage(async (message) => {
    switch (message.type) {
      case 'fetchMarket':
        return await handleFetchMarket(message);
      case 'addTracked':
        return await handleAddTracked(message);
    }
  });
});

// æ¯å€‹ handler åªè² è²¬ä¸€ä»¶äº‹
async function handleFetchMarket() { ... }
async function handleAddTracked() { ... }
```

**æ”¹é€²**ï¼š
- âœ… è·è²¬åˆ†é›¢
- âœ… æ˜“æ–¼æ–°å¢æ¶ˆæ¯é¡å‹
- âœ… éŒ¯èª¤è™•ç†çµ±ä¸€
- âœ… è¤‡é›œé‚è¼¯ç§»åˆ° utils/api.ts

### 4. é‡æ§‹ Popup çµ„ä»¶

```vue
// ç°¡åŒ–å‰
const trackedItems = ref<Item[]>([]);
// é‡è¤‡çš„ storage è¨ªå•é‚è¼¯...
if (browser...) { ... }
else if (chrome...) { ... }
else { ... }

// ç°¡åŒ–å¾Œ
const trackedItems = ref<TrackedItem[]>([]);
async function loadItems() {
  trackedItems.value = await getStorage('trackedItems') || [];
}
```

**æ”¹é€²**ï¼š
- âœ… ä»£ç¢¼æ¸›å°‘ ~40%
- âœ… é‚è¼¯æ¸…æ™°
- âœ… é¡å‹å®‰å…¨ï¼ˆä½¿ç”¨ TrackedItemï¼‰
- âœ… ä¸€è¡Œæ›¿ä»£ä¸‰å€‹æ¢ä»¶åˆ†æ”¯

### 5. é‡æ§‹ Market çµ„ä»¶

```typescript
// ç°¡åŒ–å‰
async function doSearch() {
  if (browser?.runtime?.sendMessage) {
    apiData = await browser.runtime.sendMessage(...)
  } else if (chrome?.runtime?.sendMessage) {
    apiData = await new Promise(...)
  } else {
    throw new Error(...)
  }
}

// ç°¡åŒ–å¾Œ
async function doSearch() {
  const apiData = await sendMessage({ type: 'fetchMarket', search: text });
}
```

**æ”¹é€²**ï¼š
- âœ… å¾ ~15 è¡Œæ¸›å°‘åˆ° ~3 è¡Œ
- âœ… çµ±ä¸€çš„éŒ¯èª¤è™•ç†
- âœ… é¡å‹å®‰å…¨ï¼ˆè‡ªå‹•æ¨å°éŸ¿æ‡‰é¡å‹ï¼‰

### 6. å„ªåŒ– Columns å®šç¾©

**æå–äº†ç¨ç«‹å‡½æ•¸**ï¼š
- `buildRowsFromApi()` - API æ•¸æ“šåˆ°è¡¨æ ¼æ•¸æ“šè½‰æ›
- `buildImageUrl()` - åœ–ç‰‡ URL æ§‹å»º
- `handleImageError()` - åœ–ç‰‡åŠ è¼‰é™ç´šç­–ç•¥

**æ”¹é€²**ï¼š
- âœ… å¯é‡ç”¨æ€§å¼·
- âœ… æ˜“æ–¼æ¸¬è©¦
- âœ… è·è²¬å–®ä¸€
- âœ… ä»£ç¢¼è¤‡ç”¨ï¼Œæ¸›å°‘é‡è¤‡

---

## æ”¹é€²ç¸½çµ

### ä»£ç¢¼è³ªé‡æŒ‡æ¨™

| æŒ‡æ¨™ | å‰ | å¾Œ | æ”¹å–„ |
|------|-----|-----|------|
| é¡å‹è¦†è“‹ | ~20% | 95%+ | â¬†ï¸ |
| ä»£ç¢¼é‡è¤‡ | é«˜ | ä½ | â¬‡ï¸ |
| åœˆå¤è¤‡é›œåº¦ | ä¸­ç­‰ | ä½ | â¬‡ï¸ |
| æ–‡ä»¶è¡Œæ•¸ | popup: 109, market: 325, bg: 101 | popup: 60, market: 220, bg: 90 | â¬‡ï¸ |
| æ¸¬è©¦å‹å¥½æ€§ | ä½ï¼ˆé‚è¼¯æ··äº‚ï¼‰ | é«˜ï¼ˆåˆ†é›¢é—œæ³¨é»ï¼‰ | â¬†ï¸ |

### æ¶æ§‹æ”¹é€²

```
beforeï¼ˆå–®é«”æ¶æ§‹ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  popup/App.vue      â”‚â”€â”€â”€ é›£é‡è¤‡ï¼Œé‚è¼¯æ··äº‚
â”‚  market/App.vue     â”‚â”€â”€â”€ é›£é‡è¤‡ï¼Œé‚è¼¯æ··äº‚
â”‚  background.ts      â”‚â”€â”€â”€â”€â”€â”€ è·è²¬ä¸æ¸…
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

afterï¼ˆåˆ†å±¤æ¶æ§‹ï¼‰
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  UI Components      â”‚ â† ç°¡æ½”ã€èšç„¦æ–¼ UI
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Utils & Services   â”‚ â† å¯è¤‡ç”¨ã€æ˜“æ¸¬è©¦
â”‚  - messaging.ts     â”‚
â”‚  - storage.ts       â”‚
â”‚  - api.ts          â”‚
â”‚  - constants.ts     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Type Definitions   â”‚ â† å®Œæ•´ã€å®‰å…¨
â”‚  - messages.ts      â”‚
â”‚  - storage.ts       â”‚
â”‚  - market.ts        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Entry Points       â”‚ â† ç°¡æ½”ã€é€šç”¨
â”‚  - background.ts    â”‚
â”‚  - content.ts       â”‚
â”‚  - popup/market     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### é–‹ç™¼é«”é©—æ”¹é€²

- ğŸ¯ **IDE æ”¯æŒæ›´å¥½**ï¼šå®Œæ•´çš„é¡å‹æç¤ºå’Œä»£ç¢¼è£œå…¨
- ğŸ› **éŒ¯èª¤æ›´æ˜“ç™¼ç¾**ï¼šç·¨è­¯æ™‚é¡å‹æª¢æŸ¥æ•ç² API ä½¿ç”¨éŒ¯èª¤
- ğŸ“š **æ–‡æª”æ›´æ¸…æ¥š**ï¼šé¡å‹å®šç¾©å’Œå·¥å…·å‡½æ•¸æœ¬èº«å³æ–‡æª”
- ğŸš€ **æ“´å±•æ›´å®¹æ˜“**ï¼š
  - æ–°å¢æ¶ˆæ¯é¡å‹åªéœ€æ›´æ–° `types/messages.ts`
  - æ–°å¢ API ç«¯é»åªéœ€åœ¨ `utils/api.ts` ä¸­æ·»åŠ å‡½æ•¸
  - æ–°å¢å­˜å„²æ•¸æ“šåªéœ€åœ¨ `types/storage.ts` ä¸­å®šç¾©

### ç¶­è­·æ€§æ”¹é€²

- âœ… **æ”¹å‹•å½±éŸ¿ç¯„åœæ¸…æ™°**ï¼šæ¯å€‹æ¨¡å¡Šç¨ç«‹ï¼Œæ˜“æ–¼å®šä½å•é¡Œ
- âœ… **ä¸€è‡´æ€§æ›´å¥½**ï¼šæ‰€æœ‰æ¶ˆæ¯è™•ç†éµå¾ªç›¸åŒæ¨¡å¼
- âœ… **æ›´æ˜“æ¸¬è©¦**ï¼špure å‡½æ•¸ï¼Œç„¡å‰¯ä½œç”¨ï¼Œæ˜“å–®å…ƒæ¸¬è©¦
- âœ… **é‡æ§‹æˆæœ¬ä½**ï¼šä½¿ç”¨é¡å‹ç³»çµ±ï¼Œç·¨è­¯å™¨å¹«åŠ©æª¢æŸ¥

---

## å¾ŒçºŒå»ºè­°

### çŸ­æœŸï¼ˆç«‹å³å¯¦æ–½ï¼‰
1. âœ… é‹è¡Œ `pnpm compile` é©—è­‰é¡å‹æª¢æŸ¥
2. âœ… æ¸¬è©¦å½ˆçª—åŠŸèƒ½ï¼ˆpopupï¼‰
3. âœ… æ¸¬è©¦å¸‚å ´æœå°‹é é¢ï¼ˆmarketï¼‰
4. âœ… æ¸¬è©¦ Firefox å…¼å®¹æ€§

### ä¸­æœŸï¼ˆ1-2 é€±ï¼‰
1. æ·»åŠ  unit testsï¼ˆJest + Vue Test Utilsï¼‰
   - æ¶ˆæ¯ç³»çµ±æ¸¬è©¦
   - API æœå‹™æ¸¬è©¦
   - æ•¸æ“šè½‰æ›æ¸¬è©¦
2. æ·»åŠ  E2E testsï¼ˆPlaywrightï¼‰
3. å¯¦ç¾ç°¡å–®çš„ç‹€æ…‹ç®¡ç†ï¼ˆå¦‚éœ€è¤‡é›œç‹€æ…‹ï¼‰

### é•·æœŸï¼ˆ1-3 å€‹æœˆï¼‰
1. è€ƒæ…®è™›æ“¬åŒ–åˆ—è¡¨ï¼ˆlarge datasetsï¼‰
2. æ·»åŠ æœå°‹ debounce/throttle
3. è€ƒæ…® pinia/composables åšç‹€æ…‹ç®¡ç†
4. æ·»åŠ é›¢ç·šæ”¯æŒï¼ˆIndexedDBï¼‰
5. åœ‹éš›åŒ–æ”¯æŒï¼ˆi18nï¼‰

---

## æŠ€è¡“å‚µå‹™æ¸…å–®

| é …ç›® | å„ªå…ˆç´š | ä¼°è¨ˆå·¥ä½œé‡ |
|------|--------|---------|
| æ·»åŠ  unit tests | ğŸ”´ é«˜ | 2-3 å¤© |
| æ·»åŠ  E2E tests | ğŸŸ¡ ä¸­ | 2-3 å¤© |
| æœå°‹ debounce | ğŸŸ¡ ä¸­ | 0.5 å¤© |
| è™›æ“¬åˆ—è¡¨ï¼ˆå¦‚éœ€ï¼‰ | ğŸŸ¢ ä½ | 1-2 å¤© |
| ç‹€æ…‹ç®¡ç†å±¤ï¼ˆå¦‚éœ€ï¼‰ | ğŸŸ¡ ä¸­ | 1-2 å¤© |

---

## çµè«–

é€šéæœ¬æ¬¡é‡æ§‹ï¼Œæˆ‘å€‘ï¼š
1. **æå‡äº† 95%+ çš„é¡å‹è¦†è“‹ç‡** - æ›´å°‘çš„é‹è¡Œæ™‚éŒ¯èª¤
2. **æ¸›å°‘äº†ä»£ç¢¼é‡è¤‡** - æ›´æ˜“ç¶­è­·å’Œæ“´å±•
3. **æ”¹å–„äº†ä»£ç¢¼çµ„ç¹”** - æ¸…æ™°çš„åˆ†å±¤æ¶æ§‹
4. **å¢å¼·äº†é–‹ç™¼é«”é©—** - æ›´å¥½çš„ IDE æ”¯æŒå’Œæ–‡æª”
5. **ç‚ºæœªä¾†æˆé•·å¥ å®šåŸºç¤** - æ˜“æ–¼å¼•å…¥æ¸¬è©¦ã€ç‹€æ…‹ç®¡ç†ç­‰

ç¾åœ¨é …ç›®å·²åšå¥½æº–å‚™æ‡‰å°æœªä¾†çš„åŠŸèƒ½éœ€æ±‚å’Œç¶­è­·ã€‚ ğŸš€
